CREATE OR REPLACE FUNCTION CalcolaNumeroSaleDi(codRistorante integer) --da modificare con Ristorante.codR%TYPE
RETURNS integer
AS $$
DECLARE ret integer;
BEGIN
	SELECT N_S.count INTO ret
	FROM (
		SELECT S.codR, COUNT(S.codS)
		FROM Ristorante AS R NATURAL JOIN Sala AS S
		GROUP BY S.codR
	) AS N_S
	WHERE N_S.codR = codRistorante;
	IF ret IS NULL THEN 
		ret:=0;
	END IF;
	RETURN ret;
END;
$$ LANGUAGE plpgsql;

CREATE OR REPLACE FUNCTION AggiornaNumeroSale()
RETURNS TRIGGER
AS $$
BEGIN 
	UPDATE Ristorante
	SET nÂ°sale = (SELECT CalcolaNumeroSaleDi(codR))
	WHERE codR = NEW.codR OR codR = OLD.codR;
	RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE OR REPLACE TRIGGER AggiornaNumeroSale
AFTER INSERT OR DELETE ON Sala
FOR EACH ROW
EXECUTE PROCEDURE AggiornaNumeroSale();